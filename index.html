<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xen Messenger</title>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(to bottom right, #000000, #1a1a1a, #000000);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .auth-container {
            width: 100%;
            max-width: 28rem;
            animation: slideUp 0.5s ease-out;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo-icon {
            width: 5rem;
            height: 5rem;
            background: linear-gradient(to bottom right, #ffffff, #d1d5db);
            border-radius: 1.5rem;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotate(12deg);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .logo-icon svg {
            transform: rotate(-12deg);
            color: #000000;
        }

        .logo-text {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(to right, #ffffff, #9ca3af);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .tagline {
            color: #9ca3af;
            font-size: 1.125rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            animation: shake 0.3s ease-out;
            backdrop-filter: blur(20px);
        }

        .error-text {
            color: #f87171;
            text-align: center;
            font-size: 0.875rem;
        }

        .input-field {
            width: 100%;
            padding: 1rem 1.5rem;
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .auth-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(to right, #ffffff, #e5e7eb);
            color: #000000;
            border-radius: 1rem;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .auth-button:hover {
            transform: scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .auth-button:active {
            transform: scale(0.95);
        }

        .auth-switch {
            text-align: center;
            color: #9ca3af;
        }

        .switch-button {
            color: white;
            background: none;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .switch-button:hover {
            text-decoration: underline;
        }

        .main-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            background: linear-gradient(to right, rgba(0, 0, 0, 0.8), rgba(55, 65, 81, 0.8));
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-button {
            padding: 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .search-section {
            padding: 1rem;
            animation: slideDown 0.3s ease-out;
            backdrop-filter: blur(20px);
            background: linear-gradient(to bottom right, rgba(0, 0, 0, 0.5), rgba(55, 65, 81, 0.5));
        }

        .search-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .new-chat-inputs {
            display: flex;
            gap: 0.5rem;
        }

        .new-chat-button {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border-radius: 9999px;
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .new-chat-button:hover {
            background: linear-gradient(to right, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
        }

        .action-button {
            padding: 0.75rem 1rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .action-button.primary {
            background: linear-gradient(to right, #ffffff, #e5e7eb);
            color: #000000;
        }

        .action-button.primary:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .action-button.danger {
            background: linear-gradient(to right, #ef4444, #f87171);
            color: white;
        }

        .action-button.danger:hover {
            box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.3);
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 5rem;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            transition: all 0.3s;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            animation: slideUp 0.4s ease-out;
            backdrop-filter: blur(20px);
        }

        .chat-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .avatar {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-username {
            font-weight: 600;
        }

        .verified-badge {
            width: 1rem;
            height: 1rem;
            background-color: #3b82f6;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .pin-icon {
            color: #fbbf24;
        }

        .last-message {
            font-size: 0.875rem;
            color: #9ca3af;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-header-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            background-color: rgba(0, 0, 0, 0.5);
        }

        .back-button {
            font-size: 1.5rem;
            padding: 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            animation: slideUp 0.4s ease-out;
            max-width: 100%;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 18rem;
            padding: 0.75rem 1.25rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .message-bubble.sent {
            background: linear-gradient(to bottom right, #ffffff, #f3f4f6);
            color: #000000;
        }

        .message-bubble.received {
            background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
        }

        .message-bubble.pinned {
            border: 2px solid #fbbf24;
        }

        .message-text {
            word-break: break-word;
        }

        .message-edited {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }

        .hidden-chat {
            text-align: center;
            color: #9ca3af;
            padding: 2rem;
            animation: fadeIn 0.3s ease-out;
        }

        .hidden-icon {
            width: 6rem;
            height: 6rem;
            margin: 0 auto 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
        }

        .hidden-text {
            font-size: 1.125rem;
            margin-bottom: 1rem;
        }

        .message-input-container {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(20px);
            background: linear-gradient(to bottom right, rgba(0, 0, 0, 0.8), rgba(55, 65, 81, 0.8));
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 1.25rem;
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .message-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .send-button {
            padding: 0.75rem;
            background: linear-gradient(to right, #ffffff, #e5e7eb);
            color: #000000;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .edit-input-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
        }

        .edit-actions {
            display: flex;
            gap: 0.5rem;
        }

        .edit-confirm {
            background: linear-gradient(to right, #10b981, #34d399);
            color: white;
        }

        .edit-cancel {
            background: linear-gradient(to right, #ef4444, #f87171);
            color: white;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
            animation: fadeIn 0.3s ease-out;
        }

        .modal {
            background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(2rem);
            border-radius: 1.5rem;
            padding: 2rem;
            width: 100%;
            max-width: 24rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .modal-icon {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1rem;
            background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.05));
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .modal-description {
            color: #9ca3af;
            font-size: 0.875rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .modal-action {
            flex: 1;
            padding: 0.75rem;
            border-radius: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .modal-action.secondary {
            background-color: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .modal-action.secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .modal-action.primary {
            background: linear-gradient(to right, #ffffff, #e5e7eb);
            color: #000000;
        }

        .modal-action.primary:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .modal-action:active {
            transform: scale(0.95);
        }

        .settings-screen {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            animation: fadeIn 0.3s ease-out;
            padding-bottom: 6rem;
        }

        .settings-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .profile-avatar {
            width: 7rem;
            height: 7rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.25rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .profile-info {
            text-align: center;
        }

        .profile-username {
            font-size: 1.875rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #9ca3af;
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
        }

        .settings-card {
            background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0.5rem;
            transition: all 0.3s;
            cursor: pointer;
            border-radius: 1rem;
        }

        .settings-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .settings-label {
            color: #9ca3af;
        }

        .settings-value {
            font-weight: 500;
        }

        .divider {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(to right, #ef4444, #f87171);
            color: white;
            border-radius: 1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .logout-button:hover {
            transform: scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(239, 68, 68, 0.3);
        }

        .logout-button:active {
            transform: scale(0.95);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(to right, rgba(0, 0, 0, 0.9), rgba(55, 65, 81, 0.9));
            backdrop-filter: blur(2rem);
            z-index: 40;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-item.active {
            color: white;
        }

        .nav-item.inactive {
            color: #6b7280;
        }

        .nav-icon {
            margin-bottom: 0.25rem;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 500;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        .animate-spin-slow {
            animation: spin-slow 2s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC8zwOfm5qyF_r2A1TTGCNb7pQyoaEe56w",
            authDomain: "xenmessenger.firebaseapp.com",
            databaseURL: "https://xenmessenger-default-rtdb.firebaseio.com",
            projectId: "xenmessenger",
            storageBucket: "xenmessenger.firebasestorage.app",
            messagingSenderId: "912355915340",
            appId: "1:912355915340:web:bd0d783cba08883c2d66e9",
            measurementId: "G-2BXDQJJWVW"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(app);
        const database = firebase.database(app);

        // React-like state management
        let state = {
            currentScreen: 'auth',
            isLogin: true,
            authData: { email: '', username: '', password: '' },
            currentUser: null,
            users: [],
            chats: [],
            selectedChat: null,
            message: '',
            searchQuery: '',
            showSearch: false,
            longPressChat: null,
            encryption: {},
            hidden: {},
            errorMessage: '',
            showPasswordPrompt: null,
            passwordInput: '',
            longPressMessage: null,
            editingMessage: null,
            editText: '',
            showUsernameEdit: false,
            newUsername: '',
            newChatUsername: '',
            showNewChatInput: false
        };

        // State update function
        function setState(newState) {
            state = { ...state, ...newState };
            renderApp();
        }

        // Avatar color generator
        function getAvatarColor(username) {
            const colors = [
                '#FF6B9D', '#C44569', '#FFA07A', '#FF7979',
                '#6C5CE7', '#A29BFE', '#74B9FF', '#0984E3',
                '#00B894', '#55EFC4', '#FD79A8', '#FDCB6E',
                '#E17055', '#D63031', '#F39C12', '#E74C3C'
            ];
            const index = username.charCodeAt(0) % colors.length;
            return colors[index];
        }

        // Validation functions
        function validateUsername(username) {
            return /^[a-zA-Z]{4,24}$/.test(username) || /^[a-zA-Z]{4,24}\d{1,6}$/.test(username);
        }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function validateGmail(email) {
            return /^[a-zA-Z0-9._%+-]+@gmail\.com$/.test(email);
        }

        // Authentication handler
        async function handleAuth() {
            try {
                if (state.isLogin) {
                    // Login
                    const userCredential = await firebase.auth().signInWithEmailAndPassword(
                        state.authData.email, 
                        state.authData.password
                    );
                    const user = userCredential.user;
                    
                    const userRef = firebase.database().ref(`users/${user.uid}`);
                    userRef.on('value', (snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            setState({ 
                                currentUser: { ...userData, uid: user.uid },
                                currentScreen: 'main',
                                authData: { email: '', username: '', password: '' },
                                errorMessage: ''
                            });
                        }
                    });
                } else {
                    // Registration
                    if (!state.authData.email.trim()) {
                        setState({ errorMessage: 'Email is required' });
                        return;
                    }
                    if (!validateEmail(state.authData.email)) {
                        setState({ errorMessage: 'Invalid email format' });
                        return;
                    }
                    if (!validateGmail(state.authData.email)) {
                        setState({ errorMessage: 'Only Gmail addresses are allowed' });
                        return;
                    }
                    if (!state.authData.username.trim()) {
                        setState({ errorMessage: 'Username is required' });
                        return;
                    }
                    if (!validateUsername(state.authData.username)) {
                        setState({ errorMessage: 'Username must be 4-24 English letters, optionally followed by up to 6 digits' });
                        return;
                    }
                    if (!state.authData.password.trim()) {
                        setState({ errorMessage: 'Password is required' });
                        return;
                    }
                    if (state.authData.password.length < 6) {
                        setState({ errorMessage: 'Password must be at least 6 characters' });
                        return;
                    }

                    // Check if username already exists
                    const usersRef = firebase.database().ref('users');
                    usersRef.once('value', (snapshot) => {
                        const existingUsers = snapshot.val() || {};
                        const usernameExists = Object.values(existingUsers).some(u => u.username === state.authData.username);
                        
                        if (usernameExists) {
                            setState({ errorMessage: 'Username already exists' });
                            return;
                        }

                        // Continue with registration if username is available
                        firebase.auth().createUserWithEmailAndPassword(state.authData.email, state.authData.password)
                            .then((userCredential) => {
                                const user = userCredential.user;

                                const userData = {
                                    email: state.authData.email,
                                    username: state.authData.username,
                                    password: state.authData.password,
                                    createdAt: new Date().toISOString()
                                };

                                return firebase.database().ref(`users/${user.uid}`).set(userData);
                            })
                            .then(() => {
                                const userCredential = firebase.auth().currentUser;
                                if (userCredential) {
                                    setState({ 
                                        currentUser: { 
                                            email: state.authData.email, 
                                            username: state.authData.username, 
                                            password: state.authData.password,
                                            uid: userCredential.uid 
                                        },
                                        currentScreen: 'main',
                                        authData: { email: '', username: '', password: '' },
                                        errorMessage: ''
                                    });
                                }
                            })
                            .catch((error) => {
                                setState({ errorMessage: error.message });
                            });
                    });
                }
            } catch (error) {
                setState({ errorMessage: error.message });
            }
        }

        // Send message handler
        async function handleSendMessage() {
            if (!state.message.trim() || !state.selectedChat) return;
            
            const newMessage = {
                id: Date.now().toString(),
                text: state.message,
                sender: state.currentUser.uid,
                senderUsername: state.currentUser.username,
                timestamp: new Date().toISOString(),
                deleted: false,
                edited: false,
                pinned: false
            };

            const chatRef = firebase.database().ref(`chats/${state.selectedChat.id}/messages`);
            const newMessageRef = chatRef.push();
            
            await newMessageRef.set(newMessage);
            
            // Update chat last message and timestamp
            const chatUpdateRef = firebase.database().ref(`chats/${state.selectedChat.id}`);
            await chatUpdateRef.update({
                lastMessage: state.message,
                timestamp: new Date().toISOString()
            });
            
            setState({ message: '' });
        }

        // Encryption toggle handler
        function handleEncryptionToggle() {
            setState({
                showPasswordPrompt: {
                    action: state.encryption[state.selectedChat.id] ? 'decrypt' : 'encrypt',
                    chatId: state.selectedChat.id
                }
            });
        }

        // Password submit handler
        function handlePasswordSubmit() {
            if (state.passwordInput === state.currentUser.password) {
                if (state.showPasswordPrompt.action === 'encrypt') {
                    setState({ 
                        encryption: { ...state.encryption, [state.showPasswordPrompt.chatId]: true },
                        showPasswordPrompt: null,
                        passwordInput: '',
                        errorMessage: ''
                    });
                } else {
                    setState({ 
                        encryption: { ...state.encryption, [state.showPasswordPrompt.chatId]: false },
                        showPasswordPrompt: null,
                        passwordInput: '',
                        errorMessage: ''
                    });
                }
                if (state.showPasswordPrompt.action === 'hide') {
                    setState({ 
                        hidden: { ...state.hidden, [state.showPasswordPrompt.chatId]: true },
                        showPasswordPrompt: null,
                        passwordInput: '',
                        errorMessage: ''
                    });
                }
            } else {
                setState({ errorMessage: 'Incorrect password' });
            }
        }

        // Message action handler
        async function handleMessageAction(action, messageId) {
            const messageRef = firebase.database().ref(`chats/${state.selectedChat.id}/messages`);
            
            messageRef.once('value', (snapshot) => {
                const messages = snapshot.val();
                if (messages) {
                    Object.entries(messages).forEach(([key, msg]) => {
                        if (msg.id === messageId) {
                            const updateData = {};
                            if (action === 'delete') {
                                updateData[`chats/${state.selectedChat.id}/messages/${key}/deleted`] = true;
                            } else if (action === 'pin') {
                                updateData[`chats/${state.selectedChat.id}/messages/${key}/pinned`] = !msg.pinned;
                            }
                            
                            firebase.database().ref().update(updateData);
                        }
                    });
                }
            });
            
            setState({ longPressMessage: null });
        }

        // Edit message handler
        async function handleEditMessage() {
            if (!state.editText.trim()) return;
            
            const messageRef = firebase.database().ref(`chats/${state.selectedChat.id}/messages`);
            
            messageRef.once('value', (snapshot) => {
                const messages = snapshot.val();
                if (messages) {
                    Object.entries(messages).forEach(([key, msg]) => {
                        if (msg.id === state.editingMessage) {
                            firebase.database().ref().update({
                                [`chats/${state.selectedChat.id}/messages/${key}/text`]: state.editText,
                                [`chats/${state.selectedChat.id}/messages/${key}/edited`]: true
                            });
                        }
                    });
                }
            });
            
            setState({ editingMessage: null, editText: '' });
        }

        // Username change handler
        function handleUsernameChange() {
            if (!validateUsername(state.newUsername)) {
                setState({ errorMessage: 'Username must be 4-24 English letters, optionally followed by up to 6 digits' });
                return;
            }

            // Check if username exists in Firebase
            const usersRef = firebase.database().ref('users');
            usersRef.once('value', (snapshot) => {
                const existingUsers = snapshot.val() || {};
                const usernameExists = Object.values(existingUsers).some(u => u.username === state.newUsername && u.uid !== state.currentUser.uid);
                
                if (usernameExists) {
                    setState({ errorMessage: 'Username already exists' });
                    return;
                }

                // Update username
                firebase.database().ref().update({
                    [`users/${state.currentUser.uid}/username`]: state.newUsername
                });

                const updatedUser = { ...state.currentUser, username: state.newUsername };
                setState({ 
                    currentUser: updatedUser,
                    showUsernameEdit: false,
                    newUsername: '',
                    errorMessage: ''
                });
            });
        }

        // Logout handler
        async function handleLogout() {
            try {
                await firebase.auth().signOut();
                setState({ currentUser: null, currentScreen: 'auth' });
            } catch (error) {
                setState({ errorMessage: 'Error logging out' });
            }
        }

        // Message long press handler
        let longPressTimer = null;
        function handleMessageLongPress(message) {
            longPressTimer = setTimeout(() => {
                setState({ longPressMessage: message });
            }, 500);
        }

        // Chat action handler
        async function handleChatAction(action, chatId) {
            if (action === 'delete') {
                await firebase.database().ref(`chats/${chatId}`).set(null);
                if (state.selectedChat?.id === chatId) setState({ selectedChat: null });
            } else if (action === 'pin' || action === 'unpin') {
                await firebase.database().ref(`chats/${chatId}`).update({ pinned: action === 'pin' });
            }
            setState({ longPressChat: null });
        }

        // Long press handler
        function handleLongPress(chat) {
            longPressTimer = setTimeout(() => {
                setState({ longPressChat: chat });
            }, 500);
        }

        // Touch end handler
        function handleTouchEnd() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
            }
        }

        // Create new chat handler
        function createNewChat() {
            if (!state.newChatUsername.trim()) {
                setState({ errorMessage: 'Please enter a username' });
                return;
            }

            // Check if user exists
            const usersRef = firebase.database().ref('users');
            usersRef.once('value', (snapshot) => {
                const existingUsers = snapshot.val() || {};
                const targetUser = Object.values(existingUsers).find(u => u.username === state.newChatUsername);
                
                if (!targetUser) {
                    setState({ errorMessage: 'User not found' });
                    return;
                }

                if (targetUser.uid === state.currentUser.uid) {
                    setState({ errorMessage: 'Cannot start chat with yourself' });
                    return;
                }

                // Check if chat already exists
                const existingChat = state.chats.find(chat => 
                    chat.participants && 
                    chat.participants.includes(state.currentUser.uid) && 
                    chat.participants.includes(targetUser.uid)
                );

                if (existingChat) {
                    setState({ 
                        selectedChat: existingChat,
                        newChatUsername: '',
                        showNewChatInput: false,
                        errorMessage: ''
                    });
                    return;
                }

                // Create new chat
                const newChat = {
                    participants: [state.currentUser.uid, targetUser.uid],
                    participantUsernames: [state.currentUser.username, targetUser.username],
                    lastMessage: '',
                    timestamp: new Date().toISOString(),
                    pinned: false,
                    messages: []
                };

                const chatsRef = firebase.database().ref('chats');
                const newChatRef = chatsRef.push();
                newChatRef.set(newChat).then(() => {
                    setState({ 
                        selectedChat: { id: newChatRef.key, ...newChat },
                        newChatUsername: '',
                        showNewChatInput: false,
                        errorMessage: ''
                    });
                });
            });
        }

        // Filter chats
        const filteredChats = state.chats
            .filter(chat => {
                if (!chat.participantUsernames) return false;
                const otherUser = chat.participantUsernames.find(username => username !== state.currentUser?.username);
                return otherUser?.toLowerCase().includes(state.searchQuery.toLowerCase());
            })
            .sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

        // Render the app
        function renderApp() {
            const root = document.getElementById('root');
            
            if (!state.currentUser && state.currentScreen === 'auth') {
                root.innerHTML = `
                    <div class="auth-screen">
                        <div class="auth-container">
                            <div class="auth-header">
                                <div class="logo-icon">
                                    ${lucideReact.MessageCircle.toSVG()}
                                </div>
                                <h1 class="logo-text">Xen</h1>
                                <p class="tagline">Connect with people</p>
                            </div>
                            
                            <div class="auth-form">
                                ${state.errorMessage ? `
                                    <div class="error-message">
                                        <p class="error-text">${state.errorMessage}</p>
                                    </div>
                                ` : ''}
                                
                                <input
                                    type="email"
                                    placeholder="Gmail address"
                                    value="${state.authData.email}"
                                    oninput="setState({ authData: { ...state.authData, email: event.target.value }, errorMessage: '' })"
                                    class="input-field"
                                />
                                <input
                                    type="text"
                                    placeholder="@username"
                                    value="${state.authData.username}"
                                    oninput="setState({ authData: { ...state.authData, username: event.target.value }, errorMessage: '' })"
                                    class="input-field"
                                />
                                <input
                                    type="password"
                                    placeholder="Password (min 6 characters)"
                                    value="${state.authData.password}"
                                    oninput="setState({ authData: { ...state.authData, password: event.target.value }, errorMessage: '' })"
                                    class="input-field"
                                />
                                
                                <button onclick="handleAuth()" class="auth-button">
                                    ${state.isLogin ? 'Sign In' : 'Sign Up'}
                                </button>
                                
                                <p class="auth-switch">
                                    ${state.isLogin ? "Don't have an account? " : "Already have an account? "}
                                    <button onclick="setState({ isLogin: !state.isLogin, errorMessage: '' })" class="switch-button">
                                        ${state.isLogin ? 'Sign Up' : 'Sign In'}
                                    </button>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.selectedChat) {
                const isHidden = state.hidden[state.selectedChat.id];
                const isEncrypted = state.encryption[state.selectedChat.id];
                const otherUser = state.selectedChat.participantUsernames?.find(username => username !== state.currentUser.username);
                
                root.innerHTML = `
                    <div class="chat-screen">
                        <div class="chat-header-bar">
                            <button onclick="setState({ selectedChat: null })" class="back-button">←</button>
                            <div class="chat-user-info">
                                <div class="avatar" style="background-color: ${getAvatarColor(otherUser)}">
                                    ${otherUser?.[0]?.toUpperCase()}
                                </div>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span class="chat-username">@${otherUser}</span>
                                        ${otherUser === 'xenowner' ? `
                                            <div class="verified-badge">
                                                ${lucideReact.Check.toSVG()}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            <button
                                onclick="handleEncryptionToggle()"
                                class="icon-button"
                            >
                                ${isEncrypted ? `
                                    <div style="position: relative;">
                                        ${lucideReact.Lock.toSVG()}
                                        <div style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background-color: #10b981; border-radius: 9999px; animation: pulse 2s infinite;"></div>
                                    </div>
                                ` : lucideReact.Eye.toSVG()}
                            </button>
                        </div>

                        <div class="messages-container">
                            ${!isHidden && state.selectedChat.messages ? Object.values(state.selectedChat.messages).map(msg => `
                                <div class="message ${msg.sender === state.currentUser.uid ? 'sent' : 'received'}">
                                    <div 
                                        class="message-bubble ${msg.sender === state.currentUser.uid ? 'sent' : 'received'} ${msg.pinned ? 'pinned' : ''}"
                                        ontouchstart="handleMessageLongPress(${JSON.stringify(msg).replace(/"/g, '&quot;')})"
                                        ontouchend="handleTouchEnd()"
                                        onmousedown="handleMessageLongPress(${JSON.stringify(msg).replace(/"/g, '&quot;')})"
                                        onmouseup="handleTouchEnd()"
                                        onmouseleave="handleTouchEnd()"
                                    >
                                        ${msg.deleted ? `
                                            <p class="message-text" style="font-style: italic; color: #9ca3af; font-size: 0.875rem;">This message was deleted</p>
                                        ` : `
                                            <p class="message-text">
                                                ${isEncrypted ? `
                                                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                                                        ${lucideReact.Lock.toSVG()}
                                                        <span style="font-size: 0.875rem;">${msg.text.split('').map(() => '●').join('')}</span>
                                                    </span>
                                                ` : msg.text}
                                            </p>
                                            ${msg.edited ? `
                                                <p class="message-edited">edited</p>
                                            ` : ''}
                                        `}
                                    </div>
                                </div>
                            `).join('') : ''}
                            ${isHidden ? `
                                <div class="hidden-chat">
                                    <div class="hidden-icon">
                                        ${lucideReact.EyeOff.toSVG()}
                                    </div>
                                    <p class="hidden-text">Chat is temporarily hidden</p>
                                    <button
                                        onclick="setState({ hidden: { ...state.hidden, [state.selectedChat.id]: false } })"
                                        class="new-chat-button"
                                    >
                                        Show Chat
                                    </button>
                                </div>
                            ` : ''}
                        </div>

                        <div class="message-input-container">
                            ${!isHidden && !state.editingMessage ? `
                                <input
                                    type="text"
                                    value="${state.message}"
                                    oninput="setState({ message: event.target.value })"
                                    onkeypress="if(event.key === 'Enter') handleSendMessage()"
                                    placeholder="Message..."
                                    class="message-input"
                                />
                                <button onclick="handleSendMessage()" class="send-button">
                                    ${lucideReact.Send.toSVG()}
                                </button>
                            ` : ''}
                            ${state.editingMessage ? `
                                <div class="edit-input-container">
                                    <input
                                        type="text"
                                        value="${state.editText}"
                                        oninput="setState({ editText: event.target.value })"
                                        onkeypress="if(event.key === 'Enter') handleEditMessage()"
                                        placeholder="Edit message..."
                                        class="message-input"
                                        autofocus
                                    />
                                    <div class="edit-actions">
                                        <button onclick="handleEditMessage()" class="send-button edit-confirm">
                                            ${lucideReact.Check.toSVG()}
                                        </button>
                                        <button onclick="setState({ editingMessage: null, editText: '' })" class="send-button edit-cancel">
                                            ✕
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${isHidden ? `
                                <button
                                    onclick="setState({ hidden: { ...state.hidden, [state.selectedChat.id]: false } })"
                                    class="new-chat-button"
                                >
                                    Unhide to send messages
                                </button>
                            ` : ''}
                        </div>

                        ${state.longPressMessage ? `
                            <div class="modal-overlay">
                                <div class="modal">
                                    ${!state.longPressMessage.deleted && state.longPressMessage.sender === state.currentUser.uid ? `
                                        <button
                                            onclick="setState({ editingMessage: state.longPressMessage.id, editText: state.longPressMessage.text, longPressMessage: null })"
                                            class="settings-item"
                                        >
                                            <span>✏️</span>
                                            <span>Edit</span>
                                        </button>
                                        <button
                                            onclick="handleMessageAction('pin', state.longPressMessage.id)"
                                            class="settings-item"
                                        >
                                            ${state.longPressMessage.pinned ? lucideReact.PinOff.toSVG() : lucideReact.Pin.toSVG()}
                                            <span>${state.longPressMessage.pinned ? 'Unpin' : 'Pin'}</span>
                                        </button>
                                        <button
                                            onclick="handleMessageAction('delete', state.longPressMessage.id)"
                                            class="settings-item"
                                            style="color: #f87171;"
                                        >
                                            ${lucideReact.Trash2.toSVG()}
                                            <span>Delete</span>
                                        </button>
                                    ` : ''}
                                    <button
                                        onclick="setState({ longPressMessage: null })"
                                        class="settings-item"
                                        style="font-weight: 600;"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        ${state.showPasswordPrompt ? `
                            <div class="modal-overlay">
                                <div class="modal">
                                    <div class="modal-header">
                                        <div class="modal-icon">
                                            ${lucideReact.Lock.toSVG()}
                                        </div>
                                        <h3 class="modal-title">Enter Password</h3>
                                        <p class="modal-description">
                                            ${state.showPasswordPrompt.action === 'encrypt' ? 'Enable encryption' : 'Disable encryption'}
                                        </p>
                                    </div>
                                    
                                    ${state.errorMessage ? `
                                        <div class="error-message">
                                            <p class="error-text">${state.errorMessage}</p>
                                        </div>
                                    ` : ''}
                                    
                                    <input
                                        type="password"
                                        placeholder="Your password"
                                        value="${state.passwordInput}"
                                        oninput="setState({ passwordInput: event.target.value, errorMessage: '' })"
                                        onkeypress="if(event.key === 'Enter') handlePasswordSubmit()"
                                        class="input-field"
                                        autofocus
                                    />
                                    
                                    <div class="modal-actions">
                                        <button
                                            onclick="setState({ showPasswordPrompt: null, passwordInput: '', errorMessage: '' })"
                                            class="modal-action secondary"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onclick="handlePasswordSubmit()"
                                            class="modal-action primary"
                                        >
                                            Confirm
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                return;
            }

            root.innerHTML = `
                <div class="main-screen">
                    ${state.currentScreen === 'main' ? `
                        <div class="header">
                            <h1 class="header-title">Chats</h1>
                            <div class="header-actions">
                                <button
                                    onclick="setState({ showSearch: !state.showSearch })"
                                    class="icon-button"
                                >
                                    ${lucideReact.Search.toSVG()}
                                </button>
                            </div>
                        </div>

                        ${state.showSearch ? `
                            <div class="search-section">
                                <div class="search-container">
                                    <input
                                        type="text"
                                        placeholder="Search chats..."
                                        value="${state.searchQuery}"
                                        oninput="setState({ searchQuery: event.target.value })"
                                        class="input-field"
                                    />
                                    
                                    ${!state.showNewChatInput ? `
                                        <button
                                            onclick="setState({ showNewChatInput: true })"
                                            class="new-chat-button"
                                        >
                                            <span>+ Start New Chat</span>
                                        </button>
                                    ` : `
                                        <div class="new-chat-inputs">
                                            <input
                                                type="text"
                                                placeholder="Enter username to start chat..."
                                                value="${state.newChatUsername}"
                                                oninput="setState({ newChatUsername: event.target.value, errorMessage: '' })"
                                                onkeypress="if(event.key === 'Enter') createNewChat()"
                                                class="input-field"
                                            />
                                            <button onclick="createNewChat()" class="action-button primary">
                                                Start
                                            </button>
                                            <button onclick="setState({ showNewChatInput: false, newChatUsername: '', errorMessage: '' })" class="action-button danger">
                                                ✕
                                            </button>
                                        </div>
                                    `}
                                    
                                    ${state.errorMessage ? `
                                        <div class="error-message">
                                            <p class="error-text">${state.errorMessage}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <div class="chats-list">
                            ${filteredChats.map(chat => {
                                const otherUser = chat.participantUsernames?.find(username => username !== state.currentUser.username);
                                return `
                                    <div
                                        class="chat-item"
                                        onclick="setState({ selectedChat: ${JSON.stringify(chat).replace(/"/g, '&quot;')} })"
                                        ontouchstart="handleLongPress(${JSON.stringify(chat).replace(/"/g, '&quot;')})"
                                        ontouchend="handleTouchEnd()"
                                        onmousedown="handleLongPress(${JSON.stringify(chat).replace(/"/g, '&quot;')})"
                                        onmouseup="handleTouchEnd()"
                                        onmouseleave="handleTouchEnd()"
                                    >
                                        <div class="avatar" style="background-color: ${getAvatarColor(otherUser)}">
                                            ${otherUser?.[0]?.toUpperCase()}
                                        </div>
                                        <div class="chat-info">
                                            <div class="chat-header">
                                                <span class="chat-username">@${otherUser}</span>
                                                ${otherUser === 'xenowner' ? `
                                                    <div class="verified-badge">
                                                        ${lucideReact.Check.toSVG()}
                                                    </div>
                                                ` : ''}
                                                ${chat.pinned ? `
                                                    <div class="pin-icon">
                                                        ${lucideReact.Pin.toSVG()}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <p class="last-message">${chat.lastMessage}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        ${state.longPressChat ? `
                            <div class="modal-overlay">
                                <div class="modal">
                                    <button
                                        onclick="handleChatAction('${state.longPressChat.pinned ? 'unpin' : 'pin'}', '${state.longPressChat.id}')"
                                        class="settings-item"
                                    >
                                        ${state.longPressChat.pinned ? lucideReact.PinOff.toSVG() : lucideReact.Pin.toSVG()}
                                        <span>${state.longPressChat.pinned ? 'Unpin' : 'Pin'}</span>
                                    </button>
                                    <button
                                        onclick="handleChatAction('delete', '${state.longPressChat.id}')"
                                        class="settings-item"
                                        style="color: #f87171;"
                                    >
                                        ${lucideReact.Trash2.toSVG()}
                                        <span>Delete</span>
                                    </button>
                                    <button
                                        onclick="setState({ longPressChat: null })"
                                        class="settings-item"
                                        style="font-weight: 600;"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    ` : ''}

                    ${state.currentScreen === 'settings' ? `
                        <div class="settings-screen">
                            <div class="settings-profile">
                                <div class="profile-avatar" style="background-color: ${getAvatarColor(state.currentUser.username)}">
                                    ${state.currentUser.username[0].toUpperCase()}
                                </div>
                                <div class="profile-info">
                                    <div class="profile-username">
                                        <span>@${state.currentUser.username}</span>
                                        ${state.currentUser.username === 'xenowner' ? `
                                            <div class="verified-badge">
                                                ${lucideReact.Check.toSVG()}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">Account</h3>
                                <div class="settings-card">
                                    <div class="settings-item">
                                        <span class="settings-label">Email</span>
                                        <span class="settings-value">${state.currentUser.email}</span>
                                    </div>
                                    <div class="divider"></div>
                                    <button
                                        onclick="setState({ showUsernameEdit: true, newUsername: state.currentUser.username })"
                                        class="settings-item"
                                    >
                                        <span class="settings-label">Username</span>
                                        <span class="settings-value">@${state.currentUser.username}</span>
                                    </button>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">Settings</h3>
                                <div class="settings-card">
                                    <button class="settings-item">
                                        Chat Settings
                                    </button>
                                    <button class="settings-item">
                                        Privacy
                                    </button>
                                    <button class="settings-item">
                                        Security
                                    </button>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3 class="section-title">Support</h3>
                                <div class="settings-card">
                                    <button class="settings-item">
                                        Contact Support
                                    </button>
                                </div>
                            </div>

                            <div class="settings-section">
                                <button onclick="handleLogout()" class="logout-button">
                                    Log Out
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    ${state.showUsernameEdit ? `
                        <div class="modal-overlay">
                            <div class="modal">
                                <div class="modal-header">
                                    <h3 class="modal-title">Change Username</h3>
                                    <p class="modal-description">Enter your new username</p>
                                </div>
                                
                                ${state.errorMessage ? `
                                    <div class="error-message">
                                        <p class="error-text">${state.errorMessage}</p>
                                    </div>
                                ` : ''}
                                
                                <input
                                    type="text"
                                    placeholder="@username"
                                    value="${state.newUsername}"
                                    oninput="setState({ newUsername: event.target.value, errorMessage: '' })"
                                    onkeypress="if(event.key === 'Enter') handleUsernameChange()"
                                    class="input-field"
                                    autofocus
                                />
                                
                                <div class="modal-actions">
                                    <button
                                        onclick="setState({ showUsernameEdit: false, newUsername: '', errorMessage: '' })"
                                        class="modal-action secondary"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onclick="handleUsernameChange()"
                                        class="modal-action primary"
                                    >
                                        Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="bottom-nav">
                        <div 
                            class="nav-item ${state.currentScreen === 'main' ? 'active' : 'inactive'}"
                            onclick="setState({ currentScreen: 'main' })"
                        >
                            <div class="nav-icon ${state.currentScreen === 'main' ? 'animate-bounce' : ''}">
                                ${lucideReact.MessageCircle.toSVG()}
                            </div>
                            <span class="nav-label">Chats</span>
                        </div>
                        <div 
                            class="nav-item ${state.currentScreen === 'settings' ? 'active' : 'inactive'}"
                            onclick="setState({ currentScreen: 'settings' })"
                        >
                            <div class="nav-icon ${state.currentScreen === 'settings' ? 'animate-spin-slow' : ''}">
                                ${lucideReact.Settings.toSVG()}
                            </div>
                            <span class="nav-label">Settings</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize Firebase listeners
        function initFirebaseListeners() {
            // Load users from Firebase
            const usersRef = firebase.database().ref('users');
            usersRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    setState({ users: Object.values(data) });
                }
            });

            // Load chats from Firebase
            const chatsRef = firebase.database().ref('chats');
            chatsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const chatsArray = Object.entries(data).map(([id, chat]) => ({
                        id,
                        ...chat
                    }));
                    setState({ chats: chatsArray });
                }
            });

            // Check if user is logged in
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    const userRef = firebase.database().ref(`users/${user.uid}`);
                    userRef.on('value', (snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            setState({ 
                                currentUser: { ...userData, uid: user.uid },
                                currentScreen: 'main'
                            });
                        }
                    });
                }
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            initFirebaseListeners();
            renderApp();
        });
    </script>
</body>
  </html>
